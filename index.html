<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
  <!-- Load d3.js and the geo projection plugin -->
  <script src="https://d3js.org/d3.v4.js"></script>
  <script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.25.6/d3-legend.min.js'></script>

  <meta property='og:title' content='Conservation Status of Corals' />
  <meta property='og:image' content='https://github.com/cuthchow/college-majors-visualisation/blob/master/preview.png' />
  <meta property='og:description'
    content='This interactive, scrollable data visualisation will take you on a journey through all of the different college majors in the United States, and compare how they stack up in terms of median graduate salary, gender ratios, employability, and other factors. ' />
  <meta property='og:url' content='https://cuthchow.github.io/college-majors-visualisation/' />


  <title>Conservation Status of Corals</title>
</head>


<body>
  <!-- <div id="info">
        a
    </div> -->
  <img src="https://github.com/cuthchow/college-majors-visualisation/blob/master/preview.png" alt="">
  <div id="tooltip"></div>
  <div id="graphic">
    <div id="sections">
      <section class="step">
        <div class="title"></div>
        <br><br>
        <h1>How accurate is the current conservation status of corals?</h1>
        <p>By <a href='https://www.linkedin.com/in/cuthbertchow/'>Nussa√Øbah Raja</a></p>
        <p>(Note: If the visualisation doesn't fit your screen, try zooming out with ctrl + - / Cmd + -.) </p>
        <p>
          Corals around the world are at risk of extinction due to climate change. <br><br>

          If you ever want to find out more about a bubble, just hover over it and a tooltip should appear.<br><br>

          (Data was provided by IUCN, OBIS, the Coral Traits Database and PBDB)
        </p>
      </section>
      <section class="step">
        <h1>Threatened corals in modern oceans</h1>
        <p>
          IUCN
        </p>
        <svg id='legend' width='400px' height='500px'></svg>
      </section>
      <section class="step">
        <h1>Threatened corals in modern oceans</h1>
        <p>
          Talk about recategorisation
        </p>
        <svg id='legend2' width='400px' height='500px'></svg>
      </section>
      <section class="step">
        <h1>Life history traits don't match</h1>
        <p>
          Branching vs Non Branching
        </p>
      </section>


    </div>
    <div id="vis">

    </div>
  </div>

  <script src='scroller.js'></script>

  <script>
    //visualisations

    //let svg
    let svg, map, corals, modern_traits
    let categoryColorScale, categoryLegend
    let categoryColorScale2, categoryLegend2

    const margin = {
      left: 170,
      top: 50,
      bottom: 50,
      right: 20
    }
    const width = 1000 - margin.left - margin.right
    const height = 950 - margin.top - margin.bottom

    const categories = ["Data Deficient", "Least Concern", "Near Threatened", "Vulnerable", "Endangered", "Critically Endangered"]
    const x1=[50,250,450,650,850,900]
    const y1=[50,50,50,100,100,200]
    const cols = ["#767676FF", "#155F83FF", "#8A9045FF", "#FFA319FF", "#800000FF", "black"]
    const threat_categories = ["Data Deficient", "Not Threatened", "Threatened"]
    const threat_cols = ["#767676FF", "#155F83FF", "#800000FF"]

    var yearCenters = {
  "Data Deficient": { x: width / 3, y: height / 2 },
  "Least Concern": { x: 2*width / 3, y: height / 2 },
  "Near Threatened": { x: width, y: height / 2 },
  "Vulnerable": { x: width / 3, y: height / 2 },
  "Endangered": { x: width / 2, y: height / 2 },
  "Critically Endangered": { x: 2 * width / 3, y: height / 2 }
};

    //Create all the scales and save to global variables

    function createScales() {
      categoryColorScale = d3.scaleOrdinal()
        .domain(categories)
        .range(cols)

      categoryColorScale2 = d3.scaleOrdinal()
        .domain(threat_categories)
        .range(threat_cols)

        x = d3.scaleOrdinal()
  .domain(categories)
  .range([50, 150, 250, 100,200, 350])

  y = d3.scaleOrdinal()
.domain(categories)
.range([10, 10, 10, 100,100, 200])



    }

    function createLegend(x, y) {
      let svg = d3.select('#legend')

      categoryLegend = d3.legendColor()
        .shape('path', d3.symbol().type(d3.symbolCircle).size(150)())
        .shapePadding(10)
        .scale(categoryColorScale)


      svg.append('g')
        .attr('class', 'categoryLegend')
        .attr('transform', `translate(${x},${y})`)
        .call(categoryLegend);
    }

    function createLegend2(x, y) {
      let svg = d3.select('#legend2')

      categoryLegend2 = d3.legendColor()
        .shape('path', d3.symbol().type(d3.symbolCircle).size(150)())
        .shapePadding(10)
        .scale(categoryColorScale2)


      svg.append('g')
        .attr('class', 'categoryLegend')
        .attr('transform', `translate(${x},${y})`)
        .call(categoryLegend2);
    }

    //load coordinates for plotting on map: modern corals
    d3.csv("/data/traits_iucn.csv", function(data) {
      modern_traits = data
      drawInitial()
    })

function drawInitial(){
  // creating legend for IUCN categories
  createScales()
  createLegend(20, 50)
  createLegend2(20, 50)


  let svg = d3.select("#vis")
    .append('svg')
    .attr('width', 1000)
    .attr('height', 950)
    .attr('opacity', 1)

  // make circles
  var nodes = svg.append("g")
  .selectAll("circle")
  .data(modern_traits)
  .enter()
  .append("circle")
    .attr("r", 10)
    .attr("cx", width / 2)
    .attr("cy", height / 2)
    .style("fill", "darkgrey")
    .style("fill-opacity", 0.8)
    .attr("stroke", "black")
    .style("stroke-width", 0)

    // Features of the forces applied to the nodes:
    simulation = d3.forceSimulation()
        .force("center", d3.forceCenter().x(width * 0.75).y(height / 2)) // Attraction to the center of the svg area
        .force("charge", d3.forceManyBody().strength(0.5)) // Nodes are attracted one each other of value is > 0
        .force("collide", d3.forceCollide().strength(.01).radius(30).iterations(1)) // Force that avoids circle overlapping
         .velocityDecay(0.2);

    // Apply these forces to the nodes and update their positions.
    // Once the force algorithm is happy with positions ('alpha' value is low enough), simulations will stop.
    simulation
        .nodes(modern_traits)
        .on("tick", function(d){
          nodes
              .attr("cx", function(d){ return d.x; })
              .attr("cy", function(d){ return d.y; })
        })
}

function draw1(){
  let svg = d3.select('#vis').select('svg')

  d3.selectAll("circle")
    .transition()
    .attr("duration", function(d, i) {
      return 100 + i * 0
    })
    .style("fill", "darkgrey")
}


function draw2(){
  let svg = d3.select('#vis').select('svg')

  d3.selectAll("circle")
    .transition()
    .attr("duration", function(d, i) {
      return 100 + i * 0
    })
    .style("fill", function(d) {
      return categoryColorScale(d.redlistCategory)
    })
}

function draw3(){
  let svg = d3.select('#vis').select('svg')


  svg.selectAll('circle')
        .transition().duration(400).delay((d, i) => i * 5)
        .attr('r', 5)

        function nodeYearPos(d) {
          return yearCenters[d.year].x;
        }

        function nodeYearPos(d) {
          return yearCenters[d.redlistCategory].x;
        }

        // Reset the x force of the simulation
        simulation.force('x', d3.forceX().strength(0.05).x(nodeYearPos));
        simulation.alpha(1).restart();


}
    //Array of all the graph functions
    //Will be called from the scroller functionality

    let activationFunctions = [
      draw1,
      draw2,
      draw3
    ]

    //All the scrolling function
    //Will draw a new graph based on the index provided by the scroll


    let scroll = scroller()
      .container(d3.select('#graphic'))
    scroll()

    let lastIndex, activeIndex = 0

    scroll.on('active', function(index) {
      d3.selectAll('.step')
        .transition().duration(500)
        .style('opacity', function(d, i) {
          return i === index ? 1 : 0.1;
        });

      activeIndex = index
      let sign = (activeIndex - lastIndex) < 0 ? -1 : 1;
      let scrolledSections = d3.range(lastIndex + sign, activeIndex + sign, sign);
      scrolledSections.forEach(i => {
        activationFunctions[i]();
      })
      lastIndex = activeIndex;

    })

    scroll.on('progress', function(index, progress) {
      if (index == 2 & progress > 0.7) {

      }
    })
  </script>

</body>

</html>
